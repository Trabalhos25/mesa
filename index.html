<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel da Cozinha - Pedidos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            padding: 20px;
            margin: 0;
        }

        h1 { text-align: center; color: #1a1a1a; }

        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .mesa {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            border-top: 8px solid #ccc;
        }

        /* Quando houver pedido, a mesa fica vermelha e vibrante */
        .mesa.ativa {
            border-top-color: #e74c3c;
            background: #fff5f5;
        }

        .mesa h2 { margin: 0 0 15px 0; font-size: 1.2rem; }

        .item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.95rem;
        }

        .total-container {
            margin-top: 15px;
            padding-top: 10px;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
        }

        .btn-concluir {
            width: 100%;
            margin-top: 15px;
            padding: 10px;
            border: none;
            border-radius: 6px;
            background: #27ae60;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .btn-concluir:hover { background: #219150; }
    </style>
</head>
<body>

<h1>üë®‚Äçüç≥ Painel da Cozinha</h1>

<div class="container">
    <div class="mesa" id="mesa1"><h2>MESA 1</h2></div>
    <div class="mesa" id="mesa2"><h2>MESA 2</h2></div>
    <div class="mesa" id="mesa3"><h2>MESA 3</h2></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, getDocs, deleteDoc, writeBatch 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

   const firebaseConfig = {
  apiKey: "AIzaSyAQy_vxGowwbjptqbGVYp_-_wa1eUYKvxE",
  authDomain: "cliente-mesa.firebaseapp.com",
  projectId: "cliente-mesa",
  storageBucket: "cliente-mesa.firebasestorage.app",
  messagingSenderId: "1026287310268",
  appId: "1:1026287310268:web:6557abdd6eb37b861fc7b9"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* üü¢ EXPLICA√á√ÉO DO PROFESSOR:
       Usamos o onSnapshot para criar um "t√∫nel" de comunica√ß√£o. 
       Sempre que algo mudar na subcole√ß√£o 'itens' daquela mesa, o Firebase "empurra"
       os dados novos para c√° instantaneamente.
    */
    function ouvirMesa(mesaId) {
        const mesaDiv = document.getElementById(mesaId);
        const colRef = collection(db, "pedidos", mesaId, "itens");

        onSnapshot(colRef, (snapshot) => {
            // Limpa a div mas mant√©m o t√≠tulo
            mesaDiv.innerHTML = `<h2>${mesaId.toUpperCase()}</h2>`;
            let somaTotal = 0;

            if (snapshot.empty) {
                mesaDiv.classList.remove("ativa");
                mesaDiv.innerHTML += "<p style='color: #999;'>Aguardando pedidos...</p>";
                return;
            }

            mesaDiv.classList.add("ativa");

            snapshot.forEach(doc => {
                const item = doc.data();
                somaTotal += item.preco;

                const div = document.createElement("div");
                div.className = "item";
                div.innerHTML = `<span>${item.nome}</span> <span>R$ ${item.preco.toFixed(2)}</span>`;
                mesaDiv.appendChild(div);
            });

            // Adiciona o total da comanda
            const totalDiv = document.createElement("div");
            totalDiv.className = "total-container";
            totalDiv.innerHTML = `<span>TOTAL:</span> <span>R$ ${somaTotal.toFixed(2)}</span>`;
            mesaDiv.appendChild(totalDiv);

            // Bot√£o para limpar a mesa (concluir atendimento)
            const btn = document.createElement("button");
            btn.className = "btn-concluir";
            btn.innerText = "‚úÖ CONCLUIR PEDIDO";
            btn.onclick = () => finalizarMesa(mesaId);
            mesaDiv.appendChild(btn);
        });
    }

    /* üî¥ EXPLICA√á√ÉO DO PROFESSOR:
       Para limpar a mesa, precisamos deletar cada documento dentro da subcole√ß√£o.
       Usamos um 'WriteBatch' (Lote de Escrita) para fazer isso de uma vez s√≥,
       o que √© mais eficiente e seguro.
    */
    window.finalizarMesa = async function(mesaId) {
        if(confirm(`Deseja limpar os pedidos da ${mesaId.toUpperCase()}?`)) {
            try {
                const colRef = collection(db, "pedidos", mesaId, "itens");
                const snapshot = await getDocs(colRef);
                const batch = writeBatch(db);

                snapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                console.log("Mesa finalizada!");
            } catch (error) {
                console.error("Erro ao finalizar:", error);
            }
        }
    }

    // Inicializa os ouvintes
    ouvirMesa("mesa1");
    ouvirMesa("mesa2");
    ouvirMesa("mesa3");
</script>

</body>
</html>
